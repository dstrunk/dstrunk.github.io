{"data":{"markdownRemark":{"html":"<p>One of the good (and bad) things about moving from shared hosting to a VPS is that I have full control over server settings. It might feel a little intimidating, but it’s a much more rewarding experience when everything is working properly.</p>\n<p>Today, I decided to set up a Jekyll blog for another site I’m cooking up. Not wanting to shell out for another droplet on Digital Ocean, I decided to set up a server block via Nginx using the same server this blog is hosted on. I’ll reserve how I set up Capistrano and Jekyll to automatically update my site for another day… Instead, read on for what was most difficult for me.</p>\n<h3>A crash course in nginx server blocks</h3>\n<p>Server blocks are pretty easy to understand once you get used to the syntax; here’s an example of what one looks like:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server {\n        listen 80 default_server;\n\n        root /usr/share/nginx/html;\n        index index.html index.htm;\n\n        # Make site accessible from http://localhost/\n        server_name localhost;\n\n        location / {\n                # First attempt to serve request as file, then\n                # as directory, then fall back to displaying a 404.\n                try_files $uri $uri/ /index.html;\n                # Uncomment to enable naxsi on this location\n                # include /etc/nginx/naxsi.rules\n        }\n}</code></pre></div>\n<p>This file can be called anything; for our purposes, we’ll call it <code class=\"language-text\">example-site.com</code>. Typical nginx installs expect this file to be located in <code class=\"language-text\">/etc/nginx/sites-available/</code>. From there, you’ll create a symbolic link to <code class=\"language-text\">/etc/nginx/sites-enabled/</code> to make the server block active:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ln -s /etc/nginx/sites-available/example-site.com /etc/nginx/sites-enabled/</code></pre></div>\n<p>You don’t <em>need</em> to understand everything that’s going on, I’ll just focus on the relevant parts.</p>\n<ul>\n<li>\n<p>First up is the <code class=\"language-text\">listen</code> line. <code class=\"language-text\">listen 80 default_server</code>, does pretty much what you might expect: Listen on port 80 for incoming connections, and let the server know that this is the default configuration. When having two server blocks, note that only one of these blocks can have the <code class=\"language-text\">default_server</code> part.</p>\n</li>\n<li>\n<p>Next is the <code class=\"language-text\">root [...]</code> line. This line tells the domain where your physical files are stored. Personally, I like to host my files in <code class=\"language-text\">var/www/example-site.com/</code>, where <code class=\"language-text\">example-site.com</code> is our target directory.</p>\n</li>\n<li>\n<p>Finally we’ve got the <code class=\"language-text\">server_name</code> line; for this one, you’ll want to put in your domain address, something like this: <code class=\"language-text\">server_name example-site.com;</code>.</p>\n</li>\n</ul>\n<h3>A tale of two sites</h3>\n<p>It’ll be easier to visualize this if you have two sites to work with. I like to host my sites in <code class=\"language-text\">/var/www/</code>, so let’s set up two sites in this directory now. Create two directories under <code class=\"language-text\">/var/www/</code>, called <code class=\"language-text\">example.com/</code> and <code class=\"language-text\">test.com/</code>.</p>\n<ul>\n<li>Under <code class=\"language-text\">example.com/</code> directory, create a file called <code class=\"language-text\">index.html</code>, and put the following: <code class=\"language-text\">&lt;h1&gt;Example.com works!&lt;/h1&gt;</code>.</li>\n<li>Similarly, under <code class=\"language-text\">test.com/</code> directory, create a file called <code class=\"language-text\">index.html</code>, and put the following: <code class=\"language-text\">&lt;h1&gt;Test.com works!&lt;/h1&gt;</code>.</li>\n</ul>\n<p>Now that your pseudo sites are set up, let’s move to the server blocks to make sure everything gets wired up correctly.</p>\n<h4>Example.com block</h4>\n<p>Under <code class=\"language-text\">/etc/nginx/sites-available</code>, create a new file called <code class=\"language-text\">example.com</code>. In this file, paste the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server {\n        listen 80 default_server;\n\n        root /var/www/example.com;\n        index index.html index.htm;\n\n        server_name example.com;\n}</code></pre></div>\n<p>Save your file, and create a symbolic link of this file to your <code class=\"language-text\">/etc/nginx/sites-enabled/</code> directory:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ln -s /etc/nginx/sites-available/example.com /etc/nginx/sites-enabled/</code></pre></div>\n<h4>Test.com block</h4>\n<p>Under <code class=\"language-text\">/etc/nginx/sites-available</code>, create another new file called <code class=\"language-text\">test.com</code>. In this file, paste the following:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server {\n        listen 80;\n\n        root /var/www/test.com;\n        index index.html index.htm;\n\n        server_name test.com;\n}</code></pre></div>\n<p>Save your file, and create a symbolic link of this file to your <code class=\"language-text\">/etc/nginx/sites-enabled/</code> directory:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ln -s /etc/nginx/sites-available/test.com /etc/nginx/sites-enabled/</code></pre></div>\n<h3>Testing our config and troubleshooting</h3>\n<p>Now that we’re all set up, run <code class=\"language-text\">service nginx restart</code> to make sure Nginx picks up any changes.</p>\n<p>Let’s switch to our local computer now. We obviously don’t own the <strong>example.com</strong> and <strong>test.com</strong> domains, so we’ll need to be clever about how we test our server blocks. That’s pretty simple by editing our <code class=\"language-text\">/private/etc/hosts</code> file (assuming we’re on a linux-based computer). Open up the file in the editor of your choice and add these two lines (replace <code class=\"language-text\">your.server.ip</code> with your server’s IP address):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">your.server.ip example.com\nyour.server.ip test.com</code></pre></div>\n<p>Save the file, then navigate to <strong>example.com</strong> in your browser. You should see <strong>Example.com works!</strong></p>\n<p>Navigating to <strong>test.com</strong> should show you <strong>Test.com works!</strong></p>\n<p>If for some reason either of the above options doesn’t work, you’ll need to troubleshoot. Best guess would be a syntax error in one of your server blocks. Semicolons are imperative to terminate lines—if you’re missing one, the block will never properly direct the browser.</p>\n<p>You should be all set from here. More advanced configurations are obviously possible—for example, I’ve currently got a NodeJS app, a Rails app, and a static site blog all hosted alongside each other.</p>\n<p>Until next time!</p>","frontmatter":{"title":"Setting up multiple server blocks in nginx","date":null}}},"pageContext":{"slug":"setting-up-multiple-server-blocks-in-nginx","type":"blog"}}